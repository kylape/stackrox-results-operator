/*
Copyright 2025.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
*/

package v1alpha1

import (
	metav1 "k8s.io/apimachinery/pkg/apis/meta/v1"
)

// ImageVulnerabilitySpec defines the desired state of ImageVulnerability
// NOTE: This is a read-only resource created by the operator.
// Spec is intentionally empty - all data is in Status.
type ImageVulnerabilitySpec struct {
	// This resource is managed by the operator and has no user-configurable spec.
}

// ImageReference identifies a container image
type ImageReference struct {
	// +kubebuilder:validation:Required
	Name string `json:"name"`

	// +optional
	Registry string `json:"registry,omitempty"`

	// +optional
	Remote string `json:"remote,omitempty"`

	// +optional
	Tag string `json:"tag,omitempty"`

	// +kubebuilder:validation:Required
	SHA string `json:"sha"`

	// +optional
	FullName string `json:"fullName,omitempty"`
}

// VulnerabilitySummary summarizes vulnerabilities by severity
type VulnerabilitySummary struct {
	// +optional
	Critical *SeverityCount `json:"critical,omitempty"`

	// +optional
	High *SeverityCount `json:"high,omitempty"`

	// +optional
	Medium *SeverityCount `json:"medium,omitempty"`

	// +optional
	Low *SeverityCount `json:"low,omitempty"`

	// +kubebuilder:validation:Required
	Total int `json:"total"`

	// +kubebuilder:validation:Required
	FixableTotal int `json:"fixableTotal"`
}

// SeverityCount counts vulnerabilities at a severity level
type SeverityCount struct {
	Total   int `json:"total"`
	Fixable int `json:"fixable"`
}

// CVE describes a vulnerability
// +kubebuilder:validation:XValidation:rule="true"
type CVE struct {
	// +kubebuilder:validation:Required
	CVE string `json:"cve"`

	// +kubebuilder:validation:Required
	// +kubebuilder:validation:Enum=CRITICAL;HIGH;MEDIUM;LOW;UNKNOWN
	Severity string `json:"severity"`

	// CVSS score (0-10)
	// +optional
	CVSS string `json:"cvss,omitempty"`

	// +optional
	CVSSv3 *CVSSv3 `json:"cvssV3,omitempty"`

	// +optional
	Link string `json:"link,omitempty"`

	// Version that fixes this CVE
	// +optional
	FixedBy string `json:"fixedBy,omitempty"`

	// +optional
	Component *Component `json:"component,omitempty"`

	// +optional
	EPSS *EPSS `json:"epss,omitempty"`

	// +optional
	Published *metav1.Time `json:"published,omitempty"`

	// +optional
	DiscoveredInImage *metav1.Time `json:"discoveredInImage,omitempty"`

	// +optional
	// +kubebuilder:validation:Enum=OBSERVED;DEFERRED;FALSE_POSITIVE
	State string `json:"state,omitempty"`

	// +optional
	Fixable bool `json:"fixable,omitempty"`
}

// CVSSv3 contains CVSS v3 scoring
type CVSSv3 struct {
	Score  string `json:"score"`
	Vector string `json:"vector"`
}

// Component describes a vulnerable software component
type Component struct {
	// +optional
	Name string `json:"name,omitempty"`

	// +optional
	Version string `json:"version,omitempty"`

	// +optional
	Location string `json:"location,omitempty"`
}

// EPSS contains Exploit Prediction Scoring System data
type EPSS struct {
	Score      string `json:"score"`
	Percentile string `json:"percentile"`
}

// ImageVulnerabilityStatus defines the observed state of ImageVulnerability
// This contains all the vulnerability scan data from StackRox Central
type ImageVulnerabilityStatus struct {
	// Image identification
	// +optional
	Image *ImageReference `json:"image,omitempty"`

	// When the image was last scanned
	// +optional
	ScanTime *metav1.Time `json:"scanTime,omitempty"`

	// Scanner version
	// +optional
	ScannerVersion string `json:"scannerVersion,omitempty"`

	// Operating system
	// +optional
	OperatingSystem string `json:"operatingSystem,omitempty"`

	// CVE summary by severity
	// +optional
	Summary *VulnerabilitySummary `json:"summary,omitempty"`

	// Top CVEs (limited to prevent resource bloat)
	// +optional
	// +kubebuilder:validation:MaxItems=100
	CVEs []CVE `json:"cves,omitempty"`

	// Scan notes from Central (e.g., OS_UNAVAILABLE, PARTIAL_SCAN_DATA)
	// +optional
	Notes []string `json:"notes,omitempty"`
}

// +kubebuilder:object:root=true
// +kubebuilder:subresource:status
// +kubebuilder:resource:path=imagevulnerabilities,scope=Cluster
// +kubebuilder:printcolumn:name="Image",type=string,JSONPath=`.status.image.name`
// +kubebuilder:printcolumn:name="Tag",type=string,JSONPath=`.status.image.tag`
// +kubebuilder:printcolumn:name="Critical",type=integer,JSONPath=`.status.summary.critical.total`
// +kubebuilder:printcolumn:name="High",type=integer,JSONPath=`.status.summary.high.total`
// +kubebuilder:printcolumn:name="Total",type=integer,JSONPath=`.status.summary.total`
// +kubebuilder:printcolumn:name="Fixable",type=integer,JSONPath=`.status.summary.fixableTotal`
// +kubebuilder:printcolumn:name="Scanned",type=date,JSONPath=`.status.scanTime`

// ImageVulnerability is the Schema for the imagevulnerabilities API
type ImageVulnerability struct {
	metav1.TypeMeta   `json:",inline"`
	metav1.ObjectMeta `json:"metadata,omitempty"`

	Spec   ImageVulnerabilitySpec   `json:"spec,omitempty"`
	Status ImageVulnerabilityStatus `json:"status,omitempty"`
}

// +kubebuilder:object:root=true

// ImageVulnerabilityList contains a list of ImageVulnerability
type ImageVulnerabilityList struct {
	metav1.TypeMeta `json:",inline"`
	metav1.ListMeta `json:"metadata,omitempty"`
	Items           []ImageVulnerability `json:"items"`
}

func init() {
	SchemeBuilder.Register(&ImageVulnerability{}, &ImageVulnerabilityList{})
}
